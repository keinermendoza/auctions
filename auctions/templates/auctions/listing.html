{% extends 'auctions/layout.html' %}
{% load static %}


{% block body %}

{% if not listing.active %}
    {% if best_bid %}
        {% if best_bid.offerent.id == request.user.id %}
        <div class="alert alert-primary text-center">
            <h1>Congratulations!! You Won This Listing!!</h1>
        </div>
        {% endif %}
    {% endif %}
{% endif %}

<!-- LISTING -->
<div class="row justify-content-center g-2">

    <!-- CONTAINER OF LSTING CARD -->
    <div class="col-12 col-md-8">

        <!-- LISTING CARD -->
        <div class="card mb-3 p-2" >
            <div class="row g-2">

                <!-- IMAGE -->
                <div class="col-md-6 text-center" >
                    
                        {% if listing.image %}
                        <img src="{{listing.image}}" class="card-img" style="max-height:30rem; max-width:25rem;" alt="{{listing.name}} image">
                        {% else %}
                        <img src="{% static 'auctions/default.jpg' %}" style="max-height:30rem; max-width:25rem;" class="" alt="{{listing.name}} image">
                        {% endif %}
                    
                </div>
            
                <!-- TEXT CONTAINER -->
                <div class="col-md-6">
                    
                    <!-- this row equals image and texts hights  -->
                    <div class="row h-100">

                        <div class="row aling-items-start " >
                            <div class="col">

                                <div class="card-body">
                                    <h2 class="pb-3">{{listing.name}}</h2>
                                    
                                    <h4>Description:</h4>
                                    <p >{{listing.description}}</p>

                                    <ul>
                                        {% if listing.active %}
                                        <li>Status: Active</li>
                                        {% else %}
                                        <li>Status: Closed</li>
                                        {% endif %}
                                        <li>Category: {{listing.category}}</li>
                                        <li>Seller: {{listing.seller}}</li>
                                        <li>Actual Price: {{listing.price}}.00 $</li>
                                        <li>Bids: {{listing.count}}</li>
                                    </ul>
                                    
                                    
                                  
                                </div>

                            </div>
                        </div>


                        <!-- BUTTOM SECTION -->
                        <div class="row align-items-end p-2">
                            <div class="col" >
                                <div class="row justify-content-end">
                                    
                                <!-- redirect to login page -->
                                {% if not user.is_authenticated %}

                                    <!-- text to redirect -->
                                    <div class="col-auto p-1">
                                        <p>For interact please login</p>
                                    </div>

                                    <!-- button to redirect -->
                                    <div class="col-auto">
                                        <a href="{% url 'login' %}" class="btn btn-primary m-auto">Login</a>
                                    </div>
                                {% else %}

                                    {% if request.user.id == listing.seller.id and listing.active %}
                                    <!-- CLOSE -->
                                    <div class="col-auto"> 
                                        <form action="{% url 'close_listing' %}" method="post">
                                            {% csrf_token %}
                                            <button value="{{listing.id}}" name="listing_id" class="btn btn-primary m-auto">Close</button>
                                        </form> 
                                    </div>

                                    {% endif %}

                                    {% if favorite %}
                                    <!-- UNFOLLOW -->
                                    <div class="col-auto">
                                        <form action="{% url 'in_listing_remove_to_watchlist' %}" method="post">
                                            <input type="hidden" name="favorite_id" value="{{listing.id}}">
                                            {% csrf_token %}
                                            <input class="btn btn-warning m-auto" type="submit" value="Unfollow">
                                        </form>
                                    </div>
                                    {% else %}
                                    <!-- FOLLOW -->
                                    <div class="col-auto">
                                        <form action="{% url 'add_to_watchlist' %}" method="post">
                                            {% csrf_token %}
                                            <button name="listing" value="{{listing.id}}" class="btn btn-primary m-auto">Follow</button>
                                        </form>
                                    </div>
                                    {% endif %}
                                
                                {% endif %}
                                    
                                </div> 
                            </div>
                        </div>
                        <!-- end buttom section -->
                    
                    </div>
                    <!-- end row equals height text an image -->

                </div>
                <!-- end text container/ it's a col -->

            <!-- END LISTING CARD -->
            </div>
            <!-- row -->
        </div>
        <!-- card -->
    </div>
    <!-- END CONTAINER OF LSTING CARD -->
    
    
    {% if user.is_authenticated and listing.active %}
    <!-- BID CARD -->

    <div class="col-sm-12 col-md-4">
        <div class="card p-1">
            <!-- MESSAGE -->
            {% if message %}

            <div class="alert alert-primary">
                <span>{{message}}</span>
            </div>
                
            {% endif %}

            <!-- MAKE A BID     -->
            <div class="justify-content-center text-center">
                <h2>Make a Bid!!</h2>
                <br>
                
                <form action="" method="post">
                    {% csrf_token %}
                                
                    <div class="input-group">
                        {{bid_form.price}}
                        {{bid_form.listing}}
                        {{bid_form.offerent}}
                        <span class="input-group-text">$</span>
                        <input type="submit" class=" btn btn-primary" value="New Bid">  

                    </div>
                </form>
            </div>
                              
        </div>
        <!-- end card -->
    </div>
    <!-- END BID CARD -->
    {% endif %}

</div>
<!-- end big LISTING row -->
                               

<br>
<br>

<!-- COMENTARY SECTION -->
<div class="row justify-content-center">
    <div class="col-12 col-md-8">
        <h2>Comentary Section</h2>
        <hr>
        <br>
        <h3>Make a Comment</h3>
        <!-- CREATE A COMMENTARY -->
        {% if user.is_authenticated %}
        <form action="{% url 'add_comment' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="listing_id" value="{{listing.id}}">
            <textarea class="form-control" name="commentary" id=""  rows="5" aria-placeholder="Description"></textarea>

            <div class="row justify-content-end p-1">
                <div class="col-auto">
                    <input class="btn btn-primary" type="submit" value="Comment">
                </div>
            </div>
        
        </form>
        {% endif %}

        <!-- COMMENTS -->

        <br>
        {% for comment in comments %}
        <div class="card">
            <div class="card-header">
            {{comment.user}}
            </div>
            <div class="card-body">
            <blockquote class="blockquote mb-0">
                <p>{{comment.message}}</p>
                <span class="blockquote-footer">{{comment.date}}</span>

                {% if comment.user.id == request.user.id %}
                <div class="row justify-content-end p-1">
                    <div class="col-auto">
                        <form action="{% url 'remove_comment' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="listing_id" value="{{listing.id}}">
                            <button value="{{comment.id}}" name="comment_id" class="btn btn-warning">Delete</button>
                        </form>
                    </div>
                </div>
                {% endif %}             
            </blockquote>
            </div>
        </div>

        

        {% empty %}
        <h5> There is not comment for this listing </h5>
        <h5>Be the <b>First</b> in Comment</h5>
        {% endfor %}
    </div>
</div>

{% endblock %}